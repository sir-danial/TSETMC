<!DOCTYPE html>
<html lang="fa">
<head>
    <meta charset="UTF-8">
    <title>ØªØ­Ù„ÛŒÙ„ Ù†Ù…Ø§Ø¯ Ø¨ÙˆØ±Ø³ ØªÙ‡Ø±Ø§Ù†</title>

    <style>
        /* Font (Vazir) */
        @font-face {
          font-family: "Vazir";
          src: url("/static/core/fonts/vazir/Vazir.woff2") format("woff2"),
               url("/static/core/fonts/vazir/Vazir.woff") format("woff"),
               url("/static/core/fonts/vazir/Vazir.ttf") format("truetype");
          font-weight: 400;
          font-style: normal;
          font-display: swap;
        }
        @font-face {
          font-family: "Vazir";
          src: url("/static/core/fonts/vazir/Vazir-Bold.woff2") format("woff2"),
               url("/static/core/fonts/vazir/Vazir-Bold.woff") format("woff"),
               url("/static/core/fonts/vazir/Vazir-Bold.ttf") format("truetype");
          font-weight: 700;
          font-style: normal;
          font-display: swap;
        }

        body {
            font-family: "Vazir", Tahoma, sans-serif;
            background: #0f172a;
            color: #e5e7eb;
            padding: 40px;
            direction: rtl;
        }

        .box {
            max-width: 600px;
            margin: auto;
            background: #020617;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 0 30px rgba(0,0,0,.5);
        }

        h2 { margin-bottom: 20px; }

        input, button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border-radius: 8px;
            border: none;
            font-size: 15px;
        }

        input {
            background: #020617;
            border: 1px solid #1e293b;
            color: #e5e7eb;
        }

        button {
            background: #2563eb;
            color: white;
            font-size: 16px;
            cursor: pointer;
            font-weight: 700;
        }

        button:hover { background: #1d4ed8; }

        .card {
            margin-top: 20px;
            padding: 16px;
            background: #020617;
            border-radius: 10px;
            border: 1px solid #1e293b;
        }

        .buy { color: #22c55e; }
        .sell { color: #ef4444; }
        .neutral { color: #eab308; }

        .muted { color:#94a3b8; font-size: 13px; }
        .row {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            border-bottom: 1px solid #1e293b;
            padding: 10px 0;
        }
        .row:last-child { border-bottom: none; }
        .k { color:#94a3b8; }
        .v { font-weight: bold; }
        a.back {
            display:inline-block;
            margin-bottom:12px;
            color:#93c5fd;
            text-decoration:none;
            font-size:13px;
        }
        a.back:hover{ text-decoration:underline; }
    </style>
</head>

<body>

<div class="box">
    <a class="back" href="/">â† Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
    <h2>ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù†Ù…Ø§Ø¯ Ø¨ÙˆØ±Ø³ ØªÙ‡Ø±Ø§Ù†</h2>

    <form id="analyze-form">
        <input id="symbol-input" type="text" name="symbol" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙÙ…Ù„ÛŒ" required>
        <button id="analyze-btn" type="submit">ØªØ­Ù„ÛŒÙ„ Ú©Ù†</button>
    </form>

    <div id="result" class="card" style="display:none;"></div>
</div>

<script>
(function () {
    const form = document.getElementById("analyze-form");
    const input = document.getElementById("symbol-input");
    const btn = document.getElementById("analyze-btn");
    const result = document.getElementById("result");

    function trendFa(t) {
        if (t === "up") return "ØµØ¹ÙˆØ¯ÛŒ";
        if (t === "down") return "Ù†Ø²ÙˆÙ„ÛŒ";
        return "Ø±Ù†Ø¬";
    }

    function recFa(r) {
        if (r === "buy") return { text: "Ø®Ø±ÛŒØ¯", cls: "buy" };
        if (r === "sell") return { text: "ÙØ±ÙˆØ´", cls: "sell" };
        return { text: "Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ", cls: "neutral" };
    }

    function nf(x) {
        const n = Number(x);
        if (!Number.isFinite(n)) return String(x ?? "");
        return n.toLocaleString("fa-IR");
    }

    async function analyze(symbol) {
        const url = `/api/analyze/?symbol=${encodeURIComponent(symbol)}`;
        const res = await fetch(url, { method: "GET" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const data = await res.json();
        if (data && data.error) throw new Error(data.error);
        return data;
    }

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        const symbol = (input.value || "").trim();
        if (!symbol) return;

        btn.disabled = true;
        btn.textContent = "Ø¯Ø± Ø­Ø§Ù„ ØªØ­Ù„ÛŒÙ„...";
        result.style.display = "block";
        result.innerHTML = `<p class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„ Ø¨Ø±Ø§ÛŒ <b>${symbol}</b> ...</p>`;

        try {
            const data = await analyze(symbol);

            const rec = recFa(data.recommendation);
            const reasons = Array.isArray(data.reasons) ? data.reasons : [];

            const reasonsHtml = reasons.length
                ? `<ul style="padding-right:18px; line-height:1.9; margin: 8px 0 0;">
                        ${reasons.map(r => `<li>${r}</li>`).join("")}
                   </ul>`
                : `<p class="muted" style="margin:8px 0 0;">Ø¯Ù„ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>`;

            result.innerHTML = `
                <h3 style="margin:0 0 10px;">Ù†Ù…Ø§Ø¯: ${data.symbol}</h3>

                <div class="row"><div class="k">Ù‚ÛŒÙ…Øª Ø¢Ø®Ø±</div><div class="v">${nf(data.last_price)}</div></div>
                <div class="row"><div class="k">Ø±ÙˆÙ†Ø¯ Ø¨Ø§Ø²Ø§Ø±</div><div class="v">${trendFa(data.trend)}</div></div>
                <div class="row"><div class="k">RSI</div><div class="v">${nf(data.rsi)}</div></div>
                <div class="row"><div class="k">Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú©</div><div class="v">${nf(data.risk_percent)}%</div></div>
                <div class="row"><div class="k">Ø­Ø¯ Ø¶Ø±Ø±</div><div class="v">${nf(data.stop_loss)}</div></div>
                <div class="row"><div class="k">Ø­Ø¯ Ø³ÙˆØ¯</div><div class="v">${nf(data.take_profit)}</div></div>
                <div class="row"><div class="k">Ø§Ù…ØªÛŒØ§Ø² (Score)</div><div class="v">${nf(data.score)}</div></div>

                <hr style="margin:16px 0;border-color:#1e293b">

                <h4 style="margin:0 0 6px;">ğŸ§  Ø¯Ù„Ø§ÛŒÙ„ ØªØ­Ù„ÛŒÙ„:</h4>
                ${reasonsHtml}

                <hr style="margin:16px 0;border-color:#1e293b">

                <h3 class="${rec.cls}" style="margin:0;">
                    ğŸ“Œ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ù†Ù‡Ø§ÛŒÛŒ: ${rec.text}
                </h3>
            `;
        } catch (err) {
            result.innerHTML = `
                <p style="color:#ef4444; margin:0;">âŒ Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</p>
                <p class="muted" style="margin:8px 0 0;">${String(err?.message || err)}</p>
            `;
        } finally {
            btn.disabled = false;
            btn.textContent = "ØªØ­Ù„ÛŒÙ„ Ú©Ù†";
        }
    });

    // Ø§Ú¯Ø± Ø¨Ø§ query ÙˆØ§Ø±Ø¯ Ø´Ø¯ÛŒØŒ Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ­Ù„ÛŒÙ„ Ú©Ù†
    const q = new URLSearchParams(location.search);
    const s = (q.get("symbol") || "").trim();
    if (s) {
        input.value = s;
        form.dispatchEvent(new Event("submit"));
    }
})();
</script>

</body>
</html>
