<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØªØ­Ù„ÛŒÙ„ Ù†Ù…Ø§Ø¯</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* ---------------- Font (Vazir) ---------------- */
    @font-face {
      font-family: "Vazir";
      src: url("/static/core/fonts/vazir/Vazir.woff2") format("woff2"),
           url("/static/core/fonts/vazir/Vazir.woff") format("woff"),
           url("/static/core/fonts/vazir/Vazir.ttf") format("truetype");
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: "Vazir";
      src: url("/static/core/fonts/vazir/Vazir-Bold.woff2") format("woff2"),
           url("/static/core/fonts/vazir/Vazir-Bold.woff") format("woff"),
           url("/static/core/fonts/vazir/Vazir-Bold.ttf") format("truetype");
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }

    :root{
      --bg:#0b1220;
      --card:#0a0f1a;
      --card2:#0b1423;
      --border:#1e293b;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --blue:#2563eb;
      --green:#22c55e;
      --red:#ef4444;
      --yellow:#eab308;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:28px;
      font-family:"Vazir", Tahoma, sans-serif;
      background: radial-gradient(1200px 600px at 60% -10%, rgba(37,99,235,.20), transparent 60%),
                  radial-gradient(900px 500px at 10% 0%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
      direction: rtl;
    }

    .container{ max-width:1200px; margin:0 auto; }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom: 14px;
    }

    a.back{
      display:inline-flex;
      gap:8px;
      align-items:center;
      color:#93c5fd;
      text-decoration:none;
      font-size:13px;
    }
    a.back:hover{ text-decoration:underline; }

    .title{
      font-size:18px;
      font-weight:700;
      margin:0;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .analysis-warning{
      margin: 10px 0 18px;
      padding: 12px 14px;
      border-radius: 12px;
      background: rgba(234,179,8,.12);
      border: 1px solid rgba(234,179,8,.35);
      color: #fde68a;
      font-size: 13px;
      line-height: 1.85;
      box-shadow: 0 0 25px rgba(0,0,0,.25);
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns:1fr; }
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)) , var(--card);
      border:1px solid rgba(30,41,59,.75);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 0 35px rgba(0,0,0,.35);
    }

    .muted{ color:var(--muted); font-size:13px; }

    .formRow{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
      margin-top: 10px;
    }

    input{
      flex:1;
      min-width: 200px;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid rgba(30,41,59,.75);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }

    .btn{
      padding: 12px 14px;
      border-radius: 12px;
      border:1px solid rgba(37,99,235,.45);
      background: rgba(37,99,235,.15);
      color:#dbeafe;
      cursor:pointer;
      font-weight:700;
      font-size:14px;
      transition:.15s ease;
      min-width: 120px;
    }
    .btn:hover{ background: rgba(37,99,235,.25); }
    input,
    button,
    .btn {
      font-family: "Vazir", Tahoma, sans-serif;
    }

    input::placeholder {
      font-family: "Vazir", Tahoma, sans-serif;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      margin-top: 14px;
    }
    .item{
      padding:10px 12px;
      border:1px solid rgba(30,41,59,.75);
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
    }
    .k{ color:var(--muted); font-size:12px; }
    .v{ margin-top:4px; font-size:15px; font-weight:700; }

    /* âœ… ÙÙ‚Ø· Ø¨Ø±Ø¬Ø³ØªÙ‡â€ŒØªØ± Ú©Ø±Ø¯Ù† Ú©Ø§Ø´ÛŒ Ù†Ù…Ø§Ø¯ (Ø¯Ø± live-kv) */
    #live-kv .item:first-child .v{
      font-size:18px;
      font-weight:900;
      color:#f8fafc;
      letter-spacing:.2px;
    }

    .chg.pos{ color: var(--green); }
    .chg.neg{ color: var(--red); }
    .chg.neu{ color: var(--yellow); }

    .hr{
      margin:16px 0;
      border:0;
      border-top:1px solid rgba(30,41,59,.75);
    }

    /* ---- tables ---- */
    .tableCard{
      margin-top:18px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)) , var(--card2);
      border:1px solid rgba(30,41,59,.75);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 0 35px rgba(0,0,0,.35);
    }

    .tableTitle{
      margin:0 0 12px;
      font-size:16px;
      font-weight:700;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .scroll{
      max-height: 260px;
      overflow:auto;
      border-radius:14px;
      border:1px solid rgba(30,41,59,.75);
      background: rgba(2,6,23,.25);
    }

    /* âœ… wrapper to keep sticky header reliable */
    .tableWrap{
      min-width: 100%;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      border-radius:14px;
    }

    thead th{
      background: rgba(2,6,23,.92);
      color:#e5e7eb;
      font-weight:700;
      font-size:13px;
      padding:10px 12px;
      border-bottom:1px solid rgba(30,41,59,.75);
      white-space:nowrap;

      position: sticky;
      top: 0;
      z-index: 10;
      backdrop-filter: blur(6px);
    }

    tbody td{
      padding:10px 12px;
      border-bottom:1px solid rgba(30,41,59,.55);
      color: rgba(229,231,235,.92);
      font-size:13px;
      white-space:nowrap;
    }
    tbody tr:hover td{ background: rgba(37,99,235,.06); }
    tbody tr:last-child td{ border-bottom:none; }

    .footerLine{
      margin-top:10px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      color:var(--muted);
      font-size:12px;
    }

    /* recommendation */
    .buy { color: #22c55e; }
    .sell { color: #ef4444; }
    .neutral { color: #eab308; }
  </style>
</head>

<body>
  <div class="container">

    <div class="topbar">
      <a class="back" href="/">â† Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</a>
      <h1 class="title">ğŸ“Š ØªØ­Ù„ÛŒÙ„ Ù†Ù…Ø§Ø¯ Ø¨ÙˆØ±Ø³ ØªÙ‡Ø±Ø§Ù†</h1>
    </div>

    <div class="analysis-warning">
      âš ï¸ ØªØ­Ù„ÛŒÙ„ Ø§Ø±Ø§Ø¦Ù‡â€ŒØ´Ø¯Ù‡ ØªÙˆØ³Ø· Ù…Ø§Ø´ÛŒÙ† Ø¨ÙˆØ¯Ù‡ Ùˆ Ù†Ø¨Ø§ÛŒØ¯ Ø¨Ù‡â€ŒØ¹Ù†ÙˆØ§Ù† Ù…Ø¹ÛŒØ§Ø± Ø§ØµÙ„ÛŒ ØªØµÙ…ÛŒÙ…â€ŒÚ¯ÛŒØ±ÛŒ Ø¯Ø± Ù…Ø¹Ø§Ù…Ù„Ø§Øª Ø¯Ø± Ù†Ø¸Ø± Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯.
    </div>

    <div class="grid">

      <!-- LEFT: Analysis -->
      <div class="card">
        <div class="muted">Ù†Ù…Ø§Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ Ùˆ ØªØ­Ù„ÛŒÙ„ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†ÛŒØ¯.</div>

        <form id="analyze-form" class="formRow" autocomplete="off">
          <input id="symbol-input" type="text" name="symbol" placeholder="Ù…Ø«Ù„Ø§Ù‹: ÙÙ…Ù„ÛŒ" required />
          <button id="analyze-btn" class="btn" type="submit">ØªØ­Ù„ÛŒÙ„ Ú©Ù†</button>
        </form>

        <!-- Live quick info -->
        <div class="kv" id="live-kv" style="display:none;">
          <div class="item">
            <div class="k">Ù†Ù…Ø§Ø¯</div>
            <div class="v" id="live-l18">â€”</div>
          </div>
          <div class="item">
            <div class="k">Ù†Ø§Ù…</div>
            <div class="v" id="live-l30">â€”</div>
          </div>
          <div class="item">
            <div class="k">Ú¯Ø±ÙˆÙ‡ ØµÙ†Ø¹Øª</div>
            <div class="v" id="live-cs">â€”</div>
          </div>

          <!-- âœ… (Ø§ØµÙ„Ø§Ø­ 1) Ø­Ø°Ù Ú©Ø§Ø´ÛŒ Ù‚ÛŒÙ…Øª Ø¢Ø®Ø± ØªÚ©Ø±Ø§Ø±ÛŒ Ø§Ø² live-kv -->
          <!-- <div class="item">
            <div class="k">Ù‚ÛŒÙ…Øª Ø¢Ø®Ø± (pl)</div>
            <div class="v" id="live-pl">â€”</div>
          </div> -->
        </div>

        <hr class="hr" />

        <div id="result" class="muted">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ Ù†Ù…Ø§Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</div>
      </div>

      <!-- RIGHT: Live mini cards (tables) -->
      <div>

        <div class="tableCard">
          <h3 class="tableTitle">ğŸ’° Ø¯Ø§Ø¯Ù‡ Ù‚ÛŒÙ…ØªÛŒ</h3>
          <div class="scroll">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Ø¹Ù†ÙˆØ§Ù†</th>
                    <th>Ù…Ù‚Ø¯Ø§Ø±</th>
                  </tr>
                </thead>
                <tbody id="price-body">
                  <tr><td colspan="2" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tableCard">
          <h3 class="tableTitle">ğŸ§¾ Ø¯Ø§Ø¯Ù‡ Ù…Ø¹Ø§Ù…Ù„Ø§ØªÛŒ</h3>
          <div class="scroll">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Ø¹Ù†ÙˆØ§Ù†</th>
                    <th>Ù…Ù‚Ø¯Ø§Ø±</th>
                  </tr>
                </thead>
                <tbody id="trade-body">
                  <tr><td colspan="2" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="tableCard">
          <h3 class="tableTitle">ğŸ‘¥ Ø­Ù‚ÛŒÙ‚ÛŒ Ùˆ Ø­Ù‚ÙˆÙ‚ÛŒ</h3>
          <div class="scroll">
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    <th>Ø¹Ù†ÙˆØ§Ù†</th>
                    <th>Ù…Ù‚Ø¯Ø§Ø±</th>
                  </tr>
                </thead>
                <tbody id="reallegal-body">
                  <tr><td colspan="2" class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
(function () {
  const form = document.getElementById("analyze-form");
  const input = document.getElementById("symbol-input");
  const btn = document.getElementById("analyze-btn");
  const result = document.getElementById("result");

  const liveKV = document.getElementById("live-kv");
  const elL18 = document.getElementById("live-l18");
  const elL30 = document.getElementById("live-l30");
  const elCS  = document.getElementById("live-cs");
  const elPL  = document.getElementById("live-pl"); // Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯ (ØªØºÛŒÛŒØ±ÛŒ Ø¯Ø± Ù…Ù†Ø·Ù‚ Ù†Ø¯Ø§Ø¯ÛŒÙ…)

  const priceBody = document.getElementById("price-body");
  const tradeBody = document.getElementById("trade-body");
  const rlBody    = document.getElementById("reallegal-body");

  // âœ… Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù„Ø§ÛŒÙˆ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ú©Ø§Ø±Øª ØªØ­Ù„ÛŒÙ„
  let LIVE_PL = null;
  let LIVE_PLP = null;

  const RL_LABELS = {
    Buy_CountI: "ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯ Ø­Ù‚ÛŒÙ‚ÛŒ",
    Buy_CountN: "ØªØ¹Ø¯Ø§Ø¯ Ø®Ø±ÛŒØ¯ Ø­Ù‚ÙˆÙ‚ÛŒ",
    Sell_CountI: "ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´ Ø­Ù‚ÛŒÙ‚ÛŒ",
    Sell_CountN: "ØªØ¹Ø¯Ø§Ø¯ ÙØ±ÙˆØ´ Ø­Ù‚ÙˆÙ‚ÛŒ",
    Buy_I_Volume: "Ø­Ø¬Ù… Ø®Ø±ÛŒØ¯ Ø­Ù‚ÛŒÙ‚ÛŒ",
    Buy_N_Volume: "Ø­Ø¬Ù… Ø®Ø±ÛŒØ¯ Ø­Ù‚ÙˆÙ‚ÛŒ",
    Sell_I_Volume: "Ø­Ø¬Ù… ÙØ±ÙˆØ´ Ø­Ù‚ÛŒÙ‚ÛŒ",
    Sell_N_Volume: "Ø­Ø¬Ù… ÙØ±ÙˆØ´ Ø­Ù‚ÙˆÙ‚ÛŒ",
  };

  function trendFa(t) {
    if (t === "up") return "ØµØ¹ÙˆØ¯ÛŒ";
    if (t === "down") return "Ù†Ø²ÙˆÙ„ÛŒ";
    return "Ø±Ù†Ø¬";
  }

  function recFa(r) {
    if (r === "buy") return { text: "Ø®Ø±ÛŒØ¯", cls: "buy" };
    if (r === "sell") return { text: "ÙØ±ÙˆØ´", cls: "sell" };
    return { text: "Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ", cls: "neutral" };
  }

  // âœ… Ø¹Ø¯Ø¯ ÙØ§Ø±Ø³ÛŒ + Ø§Ø¹Ø´Ø§Ø± Ø¨Ø§ "/"
  function nf(x) {
    const n = Number(x);
    if (!Number.isFinite(n)) return String(x ?? "â€”");
    const s = n.toLocaleString("fa-IR", { maximumFractionDigits: 8 });
    return s.replace(/[Ù«.]/g, "/");
  }

  function safeText(x) {
    return (x === null || x === undefined || x === "") ? "â€”" : String(x);
  }

  function chgClass(x){
    const n = Number(x);
    if (!Number.isFinite(n) || n === 0) return "chg neu";
    return n > 0 ? "chg pos" : "chg neg";
  }

  async function analyze(symbol) {
    const url = `/api/analyze/?symbol=${encodeURIComponent(symbol)}`;
    const res = await fetch(url, { method: "GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);

    const data = await res.json();
    if (data && data.error) throw new Error(data.error);
    return data;
  }

  async function fetchLiveSymbol(symbol) {
    const url = `/api/tsetmc/symbol-live/?symbol=${encodeURIComponent(symbol)}`;
    const res = await fetch(url, { method: "GET" });
    if (!res.ok) throw new Error("HTTP " + res.status);
    const data = await res.json();
    if (data && data.error) throw new Error(data.error);
    return data;
  }

  function renderKVLive(d) {
    liveKV.style.display = "grid";
    elL18.textContent = safeText(d?.l18);
    elL30.textContent = safeText(d?.l30);
    elCS.textContent  = safeText(d?.cs);

    // âœ… Ú†ÙˆÙ† Ú©Ø§Ø´ÛŒ live-pl Ø­Ø°Ù Ø´Ø¯ØŒ Ø§ÛŒÙ† ÛŒÚ©ÛŒ Ø±Ø§ Ø¯ÛŒÚ¯Ø± Ø¯Ø± DOM Ø³Øª Ù†Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    // elPL && (elPL.textContent = nf(d?.pl));

    LIVE_PL = d?.pl ?? null;
    LIVE_PLP = d?.plp ?? null;
  }

  function renderPairs(tbody, pairs) {
    if (!pairs.length) {
      tbody.innerHTML = `<tr><td colspan="2" class="muted">Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</td></tr>`;
      return;
    }
    tbody.innerHTML = pairs.map(p => `
      <tr>
        <td>${p.k}</td>
        <td>${p.v}</td>
      </tr>
    `).join("");
  }

  function renderLiveTables(d) {
    const pricePairs = [
      { k: "Ú©Ù…ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª Ø±ÙˆØ² (pmin)", v: nf(d?.pmin) },
      { k: "Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª Ø±ÙˆØ² (pmax)", v: nf(d?.pmax) },
      { k: "Ú©Ù…ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª Ù…Ø¬Ø§Ø² (tmin)", v: nf(d?.tmin) },
      { k: "Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù‚ÛŒÙ…Øª Ù…Ø¬Ø§Ø² (tmax)", v: nf(d?.tmax) },
      { k: "Ø¯ÛŒØ±ÙˆØ² (py)", v: nf(d?.py) },
      { k: "Ø§ÙˆÙ„ÛŒÙ† (pf)", v: nf(d?.pf) },
      { k: "Ù‚ÛŒÙ…Øª Ø¢Ø®Ø± (pl)", v: nf(d?.pl) },
      { k: "ØªØºÛŒÛŒØ± Ù‚ÛŒÙ…Øª Ø¢Ø®Ø± (plc)", v: nf(d?.plc) },
      { k: "Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ø¢Ø®Ø± (plp)", v: nf(d?.plp) },
      { k: "Ù¾Ø§ÛŒØ§Ù†ÛŒ (pc)", v: nf(d?.pc) },
      { k: "ØªØºÛŒÛŒØ± Ù¾Ø§ÛŒØ§Ù†ÛŒ (pcc)", v: nf(d?.pcc) },
      { k: "Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ù¾Ø§ÛŒØ§Ù†ÛŒ (pcp)", v: nf(d?.pcp) },
    ];
    renderPairs(priceBody, pricePairs);

    const tradePairs = [
      { k: "ØªØ¹Ø¯Ø§Ø¯ Ù…Ø¹Ø§Ù…Ù„Ø§Øª (tno)", v: nf(d?.tno) },
      { k: "Ø­Ø¬Ù… Ù…Ø¹Ø§Ù…Ù„Ø§Øª (tvol)", v: nf(d?.tvol) },
      { k: "Ø§Ø±Ø²Ø´ Ù…Ø¹Ø§Ù…Ù„Ø§Øª (tval)", v: nf(d?.tval) },
      { k: "Ø§Ø±Ø²Ø´ Ø¨Ø§Ø²Ø§Ø± (mv)", v: nf(d?.mv) },
      { k: "Ø­Ø¬Ù… Ù…Ø¨Ù†Ø§ (bvol)", v: nf(d?.bvol) },
      { k: "EPS", v: nf(d?.eps) },
      { k: "P/E", v: nf(d?.pe) },
      { k: "Ø¢Ø®Ø±ÛŒÙ† Ø²Ù…Ø§Ù† (time)", v: safeText(d?.time) },
    ];
    renderPairs(tradeBody, tradePairs);

    const rlKeys = [
      "Buy_CountI","Buy_CountN","Sell_CountI","Sell_CountN",
      "Buy_I_Volume","Buy_N_Volume","Sell_I_Volume","Sell_N_Volume"
    ];
    const rlPairs = rlKeys.map(key => ({
      k: RL_LABELS[key] ?? key,
      v: nf(d?.[key])
    }));
    renderPairs(rlBody, rlPairs);
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const symbol = (input.value || "").trim();
    if (!symbol) return;

    btn.disabled = true;
    btn.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª...";
    result.className = "muted";
    result.innerHTML = `Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„ Ø¨Ø±Ø§ÛŒ <b>${symbol}</b> ...`;

    try {
      const [analysis, live] = await Promise.allSettled([
        analyze(symbol),
        fetchLiveSymbol(symbol),
      ]);

      if (live.status === "fulfilled") {
        renderKVLive(live.value);
        renderLiveTables(live.value);
      } else {
        liveKV.style.display = "none";
        LIVE_PL = null;
        LIVE_PLP = null;
      }

      if (analysis.status !== "fulfilled") {
        throw analysis.reason;
      }

      const data = analysis.value;
      const rec = recFa(data.recommendation);
      const reasons = Array.isArray(data.reasons) ? data.reasons : [];

      const reasonsHtml = reasons.length
        ? `<ul style="padding-right:18px; line-height:1.9; margin: 8px 0 0;">
              ${reasons.map(r => `<li>${r}</li>`).join("")}
           </ul>`
        : `<p class="muted" style="margin:8px 0 0;">Ø¯Ù„ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª.</p>`;

      const plText = nf(LIVE_PL);
      const plpCls = chgClass(LIVE_PLP);
      const plpText = nf(LIVE_PLP) + "%";

      result.className = "";
      result.innerHTML = `
        <!-- âœ… (Ø§ØµÙ„Ø§Ø­ 2) Ø­Ø°Ù Ø¹Ù†ÙˆØ§Ù† ÙˆØ³Ø·: "Ù†Ù…Ø§Ø¯: ..."  -->

        <div class="kv" style="margin-top:12px;">
          <div class="item">
            <div class="k">Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡ (pl)</div>
            <div class="v">${plText}</div>
          </div>

          <div class="item">
            <div class="k">Ø¯Ø±ØµØ¯ ØªØºÛŒÛŒØ± Ø¢Ø®Ø±ÛŒÙ† Ù…Ø¹Ø§Ù…Ù„Ù‡ (plp)</div>
            <div class="v ${plpCls}">${plpText}</div>
          </div>

          <div class="item">
            <div class="k">Trend</div>
            <div class="v">${trendFa(data.trend)}</div>
          </div>

          <div class="item">
            <div class="k">RSI</div>
            <div class="v">${nf(data.rsi)}</div>
          </div>

          <div class="item"><div class="k">Ø¯Ø±ØµØ¯ Ø±ÛŒØ³Ú©</div><div class="v">${nf(data.risk_percent)}%</div></div>
          <div class="item"><div class="k">Ø­Ø¯ Ø¶Ø±Ø±</div><div class="v">${nf(data.stop_loss)}</div></div>
          <div class="item"><div class="k">Ø­Ø¯ Ø³ÙˆØ¯</div><div class="v">${nf(data.take_profit)}</div></div>
          <div class="item"><div class="k">Ø§Ù…ØªÛŒØ§Ø² (Score)</div><div class="v">${nf(data.score)}</div></div>
          <div class="item"><div class="k">Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯</div><div class="v ${rec.cls}">${rec.text}</div></div>
        </div>

        <hr class="hr" />

        <h4 style="margin:0 0 6px;">ğŸ§  Ø¯Ù„Ø§ÛŒÙ„ ØªØ­Ù„ÛŒÙ„:</h4>
        ${reasonsHtml}
      `;
    } catch (err) {
      result.className = "";
      result.innerHTML = `
        <p style="color:#ef4444; margin:0;">âŒ Ø¯Ø±ÛŒØ§ÙØª ØªØ­Ù„ÛŒÙ„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯</p>
        <p class="muted" style="margin:8px 0 0;">${String(err?.message || err)}</p>
      `;
    } finally {
      btn.disabled = false;
      btn.textContent = "ØªØ­Ù„ÛŒÙ„ Ú©Ù†";
    }
  });

  const q = new URLSearchParams(location.search);
  const s = (q.get("symbol") || "").trim();
  if (s) {
    input.value = s;
    form.dispatchEvent(new Event("submit"));
  }
})();
</script>

</body>
</html>
